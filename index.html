<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Hoorian POS</title>

<style>
body {
  margin: 0;
  background: #121212;
  color: #f0f0f0;
  font-family: Arial, sans-serif;
}
.header {
  background: #1e1e1e;
  padding: 15px;
  text-align: center;
  border-bottom: 1px solid #333;
}
.header h1 {
  margin: 0;
  font-size: 22px;
  color: #ff4f9a;
}
.header small {
  color: #aaa;
}
#loginOverlay {
  position: fixed;
  inset: 0;
  background: #000;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 20px;
}
#loginOverlay h2 {
  color: #ff4f9a;
  text-align: center;
}
#loginOverlay input {
  width: 100%;
  padding: 12px;
  margin: 8px 0;
  border-radius: 6px;
  border: none;
  background: #222;
  color: #fff;
}
#loginBtn {
  padding: 12px;
  background: #ff4f9a;
  border: none;
  width: 100%;
  border-radius: 6px;
  color: #fff;
  font-size: 16px;
}
.nav {
  background: #1e1e1e;
  padding: 10px;
  display: flex;
  overflow-x: auto;
}
.nav-btn {
  padding: 10px 14px;
  margin-right: 8px;
  background: #333;
  border-radius: 6px;
  cursor: pointer;
  white-space: nowrap;
  color: #ddd;
}
.nav-btn.active {
  background: #ff4f9a;
  color: #fff;
}
main {
  padding: 12px;
}
.card {
  background: #1e1e1e;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
th, td {
  border: 1px solid #444;
  padding: 6px;
}
.footer-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #1e1e1e;
  display: flex;
  justify-content: space-around;
  padding: 8px 0;
  border-top: 1px solid #333;
}
.footer-btn {
  text-align: center;
  font-size: 12px;
  color: #bbb;
}
.footer-btn.active {
  color: #ff4f9a;
}
input, select, textarea {
  background: #222;
  color: #fff;
  border: none;
  padding: 8px;
  margin: 5px 0;
  width: 100%;
  border-radius: 6px;
}
button {
  padding: 10px;
  border: none;
  border-radius: 6px;
  margin-top: 8px;
  width: 100%;
}
.btn-primary {
  background: #ff4f9a;
  color: #fff;
}
.btn-secondary {
  background: #444;
  color: #fff;
}
.btn-danger {
  background: #c00;
  color: #fff;
}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h1>Hoorian Cosmetics & Jewelry</h1>
  <small>BEAUTY • SHINE • ELEGANCE</small>
  <div id="headerDate"></div>
  <div id="headerUser"></div>
</div>

<!-- LOGIN -->
<div id="loginOverlay">
  <h2>Login</h2>
  <input id="loginUser" placeholder="Username" />
  <input id="loginPass" placeholder="Password" type="password" />
  <button id="loginBtn">Login</button>
  <p style="text-align:center;color:#888;">Default: admin / admin</p>
</div>

<!-- MENU -->
<div class="nav">
  <div class="nav-btn active" data-view="dashboardView">Dashboard</div>
  <div class="nav-btn" data-view="inventoryView">Inventory</div>
  <div class="nav-btn" data-view="salesView">Sales</div>
  <div class="nav-btn" data-view="expensesView">Expenses</div>
  <div class="nav-btn" data-view="invoicesView">Invoices</div>
  <div class="nav-btn" data-view="settingsView">Settings</div>
</div>

<main>

<!-- DASHBOARD -->
<section id="dashboardView" class="card">
  <h2>Dashboard</h2>
  <p><strong>Today Sales:</strong> <span id="statTodaySales">0</span> PKR</p>
  <p><strong>This Month:</strong> <span id="statMonthSales">0</span> PKR</p>
  <p><strong>Profit:</strong> <span id="statProfit">0</span> PKR</p>
  <p><strong>Margin:</strong> <span id="statMargin">0%</span></p>
  <h3>Stock Alerts</h3>
  <table id="dashboardStockTable"><tbody></tbody></table>
</section>
  <!-- INVENTORY -->
<section id="inventoryView" class="card" style="display:none;">
  <h2>Inventory</h2>

  <input id="invSearch" placeholder="Search product..." />
  <select id="invFilterCategory">
    <option value="">All Categories</option>
    <option value="Cosmetics">Cosmetics</option>
    <option value="Jewelry">Jewelry</option>
    <option value="Undergarments">Undergarments</option>
  </select>

  <table id="invTable">
    <thead>
      <tr><th>Code</th><th>Name</th><th>Cat</th><th>Stock</th><th>Price</th><th>Tags</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Add / Edit Product</h3>
  <input id="invCode" placeholder="Code" />
  <input id="invName" placeholder="Name" />
  <select id="invCategory">
    <option value="Cosmetics">Cosmetics</option>
    <option value="Jewelry">Jewelry</option>
    <option value="Undergarments">Undergarments</option>
  </select>
  <input id="invStock" type="number" placeholder="Stock" />
  <input id="invLowStock" type="number" placeholder="Low Stock Level" />
  <input id="invCost" type="number" placeholder="Cost Price" />
  <input id="invPrice" type="number" placeholder="Selling Price" />
  <label><input type="checkbox" id="invHotSale" /> Hot Sale</label>
  <button id="btnSaveProduct" class="btn-primary">Save Product</button>
  <button id="btnClearProduct" class="btn-secondary">Clear</button>
</section>

<!-- SALES / POS -->
<section id="salesView" class="card" style="display:none;">
  <h2>Sales / POS</h2>

  <input id="posSearch" placeholder="Search product..." />
  <table id="posSearchTable">
    <thead>
      <tr><th>Code</th><th>Name</th><th>Cat</th><th>Stock</th><th>Price</th><th>Add</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>Cart</h3>
  <table id="cartTable">
    <thead>
      <tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th><th>X</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="cartItemsCount">Items: 0</p>
  <p id="cartTotalAmount">Total: 0 PKR</p>

  <input id="cartCustomerName" placeholder="Customer Name" />
  <input id="cartNotes" placeholder="Notes" />
  <button id="btnCheckout" class="btn-primary">Checkout</button>
  <button id="btnClearCart" class="btn-secondary">Clear Cart</button>
</section>

<!-- EXPENSES -->
<section id="expensesView" class="card" style="display:none;">
  <h2>Expenses</h2>

  <input id="expTitle" placeholder="Title" />
  <input id="expAmount" type="number" placeholder="Amount" />
  <input id="expDate" type="date" />
  <input id="expNote" placeholder="Note" />
  <button id="btnAddExpense" class="btn-primary">Add Expense</button>

  <table id="expTable">
    <thead>
      <tr><th>Date</th><th>Title</th><th>Amount</th><th>X</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <p><strong>Total Expenses:</strong> <span id="expTotal">0</span> PKR</p>
</section>

<!-- INVOICES -->
<section id="invoicesView" class="card" style="display:none;">
  <h2>Invoices</h2>

  <input id="invSearchInvoice" placeholder="Search invoice or customer..." />
  <table id="invoiceTable">
    <thead>
      <tr><th>No.</th><th>Date</th><th>Customer</th><th>Total</th><th>Items</th><th>Return</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="countInvoices">Invoices: 0</p>

  <h3>Invoice Detail</h3>
  <div id="invoiceDetail">Select an invoice to view details.</div>
  <button id="btnPrintSlip" class="btn-secondary">Print Slip</button>
  <button id="btnPrintA4" class="btn-secondary">Print A4</button>
</section>
  <!-- SETTINGS -->
<section id="settingsView" class="card" style="display:none;">
  <h2>Settings & Backup</h2>

  <h3>Login</h3>
  <input id="setUser" placeholder="Username" />
  <input id="setPass" placeholder="Password" type="password" />
  <button id="btnSaveLogin" class="btn-primary">Save Login</button>

  <h3>Backup / Restore</h3>
  <button id="btnExportData" class="btn-secondary">Export Data</button>
  <button id="btnImportData" class="btn-secondary">Import Data</button>
  <button id="btnClearAllData" class="btn-danger">Clear All Data</button>
  <textarea id="backupJson" rows="6" placeholder="Backup JSON here..." style="margin-top:8px;"></textarea>
</section>

</main>

<!-- FOOTER NAV (optional icons text only) -->
<div class="footer-nav">
  <div class="footer-btn" data-view="dashboardView">Home</div>
  <div class="footer-btn" data-view="inventoryView">Stock</div>
  <div class="footer-btn" data-view="salesView">Sales</div>
  <div class="footer-btn" data-view="invoicesView">Bills</div>
  <div class="footer-btn" data-view="settingsView">Settings</div>
</div>

<script>
const KEY_PRODUCTS = "hoorian_products";
const KEY_INVOICES = "hoorian_invoices";
const KEY_EXPENSES = "hoorian_expenses";
const KEY_LOGIN = "hoorian_login";

let products = [];
let invoices = [];
let expenses = [];
let cart = [];
let currentInvoiceForPrint = null;

function todayStr() {
  const d = new Date();
  return d.toISOString().slice(0, 10);
}
function formatDate(str) {
  if (!str) return "";
  return str.slice(0, 10);
}
function sameDay(a, b) {
  return a.getFullYear() === b.getFullYear() &&
         a.getMonth() === b.getMonth() &&
         a.getDate() === b.getDate();
}
function monthKey(d) {
  return d.getFullYear() + "-" + (d.getMonth() + 1);
}
function generateInvoiceNumber() {
  const n = invoices.length + 1;
  return "INV" + String(n).padStart(4, "0");
}

function loadData() {
  products = JSON.parse(localStorage.getItem(KEY_PRODUCTS) || "[]");
  invoices = JSON.parse(localStorage.getItem(KEY_INVOICES) || "[]");
  expenses = JSON.parse(localStorage.getItem(KEY_EXPENSES) || "[]");

  if (!localStorage.getItem(KEY_LOGIN)) {
    localStorage.setItem(KEY_LOGIN, JSON.stringify({ username: "admin", password: "admin" }));
  }
}
function saveProducts() {
  localStorage.setItem(KEY_PRODUCTS, JSON.stringify(products));
}
function saveInvoices() {
  localStorage.setItem(KEY_INVOICES, JSON.stringify(invoices));
}
function saveExpenses() {
  localStorage.setItem(KEY_EXPENSES, JSON.stringify(expenses));
}

const headerDate = document.getElementById("headerDate");
const headerUser = document.getElementById("headerUser");
function updateHeaderDate() {
  headerDate.textContent = new Date().toLocaleString();
}

const loginOverlay = document.getElementById("loginOverlay");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");
const loginBtn = document.getElementById("loginBtn");

loginBtn.addEventListener("click", () => {
  const u = loginUser.value.trim();
  const p = loginPass.value.trim();
  const saved = JSON.parse(localStorage.getItem(KEY_LOGIN) || "null");
  if (!saved || u !== saved.username || p !== saved.password) {
    alert("Wrong username or password");
    return;
  }
  loginOverlay.style.display = "none";
  headerUser.textContent = "Logged in as: " + u;
});

const navBtns = document.querySelectorAll(".nav-btn");
const footerBtns = document.querySelectorAll(".footer-btn");
const views = document.querySelectorAll("main section");

function showView(id) {
  views.forEach(v => v.style.display = (v.id === id ? "block" : "none"));
  navBtns.forEach(b => b.classList.toggle("active", b.getAttribute("data-view") === id));
  footerBtns.forEach(b => b.classList.toggle("active", b.getAttribute("data-view") === id));
}
navBtns.forEach(btn => {
  btn.addEventListener("click", () => showView(btn.getAttribute("data-view")));
});
footerBtns.forEach(btn => {
  btn.addEventListener("click", () => showView(btn.getAttribute("data-view")));
});

/* INVENTORY */
const invSearch = document.getElementById("invSearch");
const invFilterCategory = document.getElementById("invFilterCategory");
const invTableBody = document.querySelector("#invTable tbody");
const invCode = document.getElementById("invCode");
const invName = document.getElementById("invName");
const invCategory = document.getElementById("invCategory");
const invStock = document.getElementById("invStock");
const invLowStock = document.getElementById("invLowStock");
const invCost = document.getElementById("invCost");
const invPrice = document.getElementById("invPrice");
const invHotSale = document.getElementById("invHotSale");
const btnSaveProduct = document.getElementById("btnSaveProduct");
const btnClearProduct = document.getElementById("btnClearProduct");

function renderInventory() {
  invTableBody.innerHTML = "";
  const search = invSearch.value.trim().toLowerCase();
  const cat = invFilterCategory.value;
  products.forEach(p => {
    if (search && !(p.name.toLowerCase().includes(search) || p.code.toLowerCase().includes(search))) return;
    if (cat && p.category !== cat) return;
    const tags = [];
    if (p.stock <= p.lowStock) tags.push("Low");
    if (p.hotSale) tags.push("Hot");
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${p.stock}</td>
      <td>${p.price.toFixed(0)}</td>
      <td>${tags.join(", ")}</td>
      <td><button class="btn-secondary" data-code="${p.code}">Edit</button></td>
    `;
    invTableBody.appendChild(tr);
  });
}
invSearch.addEventListener("input", renderInventory);
invFilterCategory.addEventListener("change", renderInventory);

invTableBody.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const code = btn.getAttribute("data-code");
  const p = products.find(x => x.code === code);
  if (!p) return;
  invCode.value = p.code;
  invName.value = p.name;
  invCategory.value = p.category;
  invStock.value = p.stock;
  invLowStock.value = p.lowStock;
  invCost.value = p.cost;
  invPrice.value = p.price;
  invHotSale.checked = !!p.hotSale;
});

btnClearProduct.addEventListener("click", () => {
  invCode.value = "";
  invName.value = "";
  invStock.value = "";
  invLowStock.value = "";
  invCost.value = "";
  invPrice.value = "";
  invHotSale.checked = false;
});

btnSaveProduct.addEventListener("click", () => {
  const code = invCode.value.trim();
  const name = invName.value.trim();
  const category = invCategory.value;
  const stock = parseInt(invStock.value || "0", 10);
  const lowStock = parseInt(invLowStock.value || "0", 10);
  const cost = parseFloat(invCost.value || "0");
  const price = parseFloat(invPrice.value || "0");
  const hotSale = invHotSale.checked;
  if (!code || !name) return alert("Code and name required");
  let existing = products.find(p => p.code === code);
  if (existing) {
    existing.name = name;
    existing.category = category;
    existing.stock = stock;
    existing.lowStock = lowStock;
    existing.cost = cost;
    existing.price = price;
    existing.hotSale = hotSale;
  } else {
    products.push({ code, name, category, stock, lowStock, cost, price, hotSale });
  }
  saveProducts();
  renderInventory();
  refreshDashboard();
  alert("Product saved");
});

/* POS / SALES */
const posSearch = document.getElementById("posSearch");
const posSearchTableBody = document.querySelector("#posSearchTable tbody");
const cartTableBody = document.querySelector("#cartTable tbody");
const cartItemsCount = document.getElementById("cartItemsCount");
const cartTotalAmount = document.getElementById("cartTotalAmount");
const cartCustomerName = document.getElementById("cartCustomerName");
const cartNotes = document.getElementById("cartNotes");

function renderPosSearch() {
  posSearchTableBody.innerHTML = "";
  const search = posSearch.value.trim().toLowerCase();
  products.forEach(p => {
    if (search && !(p.name.toLowerCase().includes(search) || p.code.toLowerCase().includes(search))) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${p.stock}</td>
      <td>${p.price.toFixed(0)}</td>
      <td><button class="btn-primary" data-code="${p.code}">Add</button></td>
    `;
    posSearchTableBody.appendChild(tr);
  });
}
posSearch.addEventListener("input", renderPosSearch);

posSearchTableBody.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const code = btn.getAttribute("data-code");
  const product = products.find(p => p.code === code);
  if (!product) return;
  if (product.stock <= 0) return alert("No stock available");
  const existing = cart.find(c => c.code === code);
  if (existing) {
    if (existing.qty + 1 > product.stock) return alert("Not enough stock");
    existing.qty += 1;
  } else {
    cart.push({ code: product.code, name: product.name, price: product.price, qty: 1 });
  }
  renderCart();
});

function renderCart() {
  cartTableBody.innerHTML = "";
  let total = 0;
  cart.forEach((item, index) => {
    const lineTotal = item.qty * item.price;
    total += lineTotal;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.name}</td>
      <td><input type="number" min="1" value="${item.qty}" data-index="${index}" class="cart-qty" style="width:60px;" /></td>
      <td>${item.price.toFixed(0)}</td>
      <td>${lineTotal.toFixed(0)}</td>
      <td><button class="btn-danger" data-index="${index}">X</button></td>
    `;
    cartTableBody.appendChild(tr);
  });
  cartItemsCount.textContent = "Items: " + cart.length;
  cartTotalAmount.textContent = "Total: " + total.toFixed(0) + " PKR";
}

cartTableBody.addEventListener("input", e => {
  if (!e.target.classList.contains("cart-qty")) return;
  const index = parseInt(e.target.getAttribute("data-index"), 10);
  const qty = parseInt(e.target.value || "1", 10);
  if (isNaN(qty) || qty <= 0) return;
  const item = cart[index];
  const product = products.find(p => p.code === item.code);
  if (!product) return;
  if (qty > product.stock) {
    alert("Not enough stock");
    e.target.value = product.stock;
    cart[index].qty = product.stock;
  } else {
    cart[index].qty = qty;
  }
  renderCart();
});

cartTableBody.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const index = parseInt(btn.getAttribute("data-index"), 10);
  cart.splice(index, 1);
  renderCart();
});

document.getElementById("btnClearCart").addEventListener("click", () => {
  if (!confirm("Clear cart?")) return;
  cart = [];
  renderCart();
});

document.getElementById("btnCheckout").addEventListener("click", () => {
  if (cart.length === 0) return alert("Cart is empty");
  let total = 0;
  cart.forEach(item => total += item.qty * item.price);
  const invoiceNo = generateInvoiceNumber();
  const now = new Date();
  const invoice = {
    number: invoiceNo,
    date: now.toISOString(),
    customer: cartCustomerName.value.trim() || "Walk-in",
    notes: cartNotes.value.trim(),
    items: cart.map(c => ({ ...c })),
    total: total,
    returned: false
  };
  invoices.push(invoice);
  saveInvoices();
  cart.forEach(item => {
    const p = products.find(p => p.code === item.code);
    if (p) {
      p.stock -= item.qty;
      if (p.stock < 0) p.stock = 0;
    }
  });
  saveProducts();
  alert("Invoice created: " + invoiceNo);
  cart = [];
  cartCustomerName.value = "";
  cartNotes.value = "";
  renderCart();
  renderInventory();
  refreshDashboard();
  renderInvoices();
});

/* EXPENSES */
const expTitle = document.getElementById("expTitle");
const expAmount = document.getElementById("expAmount");
const expDate = document.getElementById("expDate");
const expNote = document.getElementById("expNote");
const expTableBody = document.querySelector("#expTable tbody");
const expTotal = document.getElementById("expTotal");

document.getElementById("btnAddExpense").addEventListener("click", () => {
  const title = expTitle.value.trim();
  const amount = parseFloat(expAmount.value || "0");
  const date = expDate.value || todayStr();
  if (!title || amount <= 0) return alert("Title and amount required");
  expenses.push({ id: Date.now(), title, amount, date, note: expNote.value.trim() });
  saveExpenses();
  expTitle.value = "";
  expAmount.value = "";
  expDate.value = "";
  expNote.value = "";
  renderExpenses();
  refreshDashboard();
});

function renderExpenses() {
  expTableBody.innerHTML = "";
  let total = 0;
  expenses.forEach(exp => {
    total += exp.amount;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${formatDate(exp.date)}</td>
      <td>${exp.title}</td>
      <td>${exp.amount.toFixed(0)}</td>
      <td><button class="btn-danger" data-id="${exp.id}">X</button></td>
    `;
    expTableBody.appendChild(tr);
  });
  expTotal.textContent = total.toFixed(0);
}
expTableBody.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const id = parseInt(btn.getAttribute("data-id"), 10);
  const idx = expenses.findIndex(exp => exp.id === id);
  if (idx >= 0 && confirm("Delete this expense?")) {
    expenses.splice(idx, 1);
    saveExpenses();
    renderExpenses();
    refreshDashboard();
  }
});

/* INVOICES */
const invoiceTableBody = document.querySelector("#invoiceTable tbody");
const invoiceDetail = document.getElementById("invoiceDetail");
const invSearchInvoice = document.getElementById("invSearchInvoice");
const countInvoices = document.getElementById("countInvoices");

function renderInvoices() {
  invoiceTableBody.innerHTML = "";
  const search = invSearchInvoice.value.trim().toLowerCase();
  invoices.forEach((inv, index) => {
    if (search && !(inv.number.toLowerCase().includes(search) || inv.customer.toLowerCase().includes(search))) return;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><button class="btn-secondary" data-index="${index}" data-action="view">${inv.number}</button></td>
      <td>${formatDate(inv.date)}</td>
      <td>${inv.customer}</td>
      <td>${inv.total.toFixed(0)}</td>
      <td>${inv.items.length}</td>
      <td>
        ${
          inv.returned
            ? "Returned"
            : '<button class="btn-danger" data-index="' + index + '" data-action="return">Return</button>'
        }
      </td>
    `;
    invoiceTableBody.appendChild(tr);
  });
  countInvoices.textContent = "Invoices: " + invoices.length;
}

invoiceTableBody.addEventListener("click", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  const index = parseInt(btn.getAttribute("data-index"), 10);
  const action = btn.getAttribute("data-action");
  const inv = invoices[index];
  if (!inv) return;
  if (action === "view") {
    showInvoiceDetail(inv);
  } else if (action === "return") {
    if (inv.returned) return alert("Already returned");
    if (!confirm("Mark this invoice as returned and add items back to stock?")) return;
    inv.returned = true;
    inv.items.forEach(item => {
      const p = products.find(p => p.code === item.code);
      if (p) p.stock += item.qty;
    });
    saveInvoices();
    saveProducts();
    renderInvoices();
    renderInventory();
    refreshDashboard();
  }
});

function showInvoiceDetail(inv) {
  let html = "";
  html += "<div><strong>Invoice:</strong> " + inv.number + "</div>";
  html += "<div><strong>Date:</strong> " + formatDate(inv.date) + "</div>";
  html += "<div><strong>Customer:</strong> " + inv.customer + "</div>";
  html += "<div><strong>Total:</strong> " + inv.total.toFixed(0) + " PKR</div>";
  html += "<div><strong>Returned:</strong> " + (inv.returned ? "Yes" : "No") + "</div>";
  if (inv.notes) html += "<div><strong>Notes:</strong> " + inv.notes + "</div>";
  html += "<h4 style='margin-top:8px;'>Items</h4>";
  html += "<table style='width:100%;font-size:12px;border-collapse:collapse;'>";
  html += "<tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
  inv.items.forEach(it => {
    html += `
      <tr>
        <td>${it.name}</td>
        <td>${it.qty}</td>
        <td>${it.price.toFixed(0)}</td>
        <td>${(it.qty * it.price).toFixed(0)}</td>
      </tr>
    `;
  });
  html += "</table>";
  invoiceDetail.innerHTML = html;
  currentInvoiceForPrint = inv;
}
invSearchInvoice.addEventListener("input", renderInvoices);

/* DASHBOARD */
const statTodaySales = document.getElementById("statTodaySales");
const statMonthSales = document.getElementById("statMonthSales");
const statProfit = document.getElementById("statProfit");
const statMargin = document.getElementById("statMargin");
const dashboardStockTableBody = document.querySelector("#dashboardStockTable tbody");

function refreshDashboard() {
  let todaySales = 0;
  let monthSales = 0;
  let totalSales = 0;
  const now = new Date();
  const currentMonth = monthKey(now);
  invoices.forEach(inv => {
    const d = new Date(inv.date);
    const amount = inv.total;
    totalSales += amount;
    if (sameDay(d, now)) todaySales += amount;
    if (monthKey(d) === currentMonth) monthSales += amount;
  });
  let totalExpenses = 0;
  expenses.forEach(exp => totalExpenses += exp.amount);
  const profit = totalSales - totalExpenses;
  const margin = totalSales > 0 ? (profit / totalSales) * 100 : 0;
  statTodaySales.textContent = todaySales.toFixed(0);
  statMonthSales.textContent = monthSales.toFixed(0);
  statProfit.textContent = profit.toFixed(0);
  statMargin.textContent = margin.toFixed(1) + "%";

  dashboardStockTableBody.innerHTML = "";
  products.forEach(p => {
    if (!(p.stock <= p.lowStock || p.hotSale)) return;
    const tr = document.createElement("tr");
    const tags = [];
    if (p.stock <= p.lowStock) tags.push("Low");
    if (p.hotSale) tags.push("Hot");
    tr.innerHTML = `
      <td>${p.code}</td>
      <td>${p.name}</td>
      <td>${p.category}</td>
      <td>${p.stock}</td>
      <td>${tags.join(", ")}</td>
    `;
    dashboardStockTableBody.appendChild(tr);
  });
}

/* PRINTING */
function openPrintWindow(html, title) {
  const w = window.open("", "_blank", "width=600,height=800");
  if (!w) return alert("Popup blocked. Allow popups to print.");
  w.document.write(`
    <html>
      <head>
        <title>${title}</title>
        <style>
          body { font-family: Arial, sans-serif; font-size: 12px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { border: 1px solid #000; padding: 4px; }
          h3 { margin: 4px 0; }
        </style>
      </head>
      <body>${html}</body>
    </html>
  `);
  w.document.close();
  w.focus();
  w.print();
}

document.getElementById("btnPrintSlip").addEventListener("click", () => {
  if (!currentInvoiceForPrint) return alert("Select an invoice first");
  const inv = currentInvoiceForPrint;
  let html = "";
  html += "<h3 style='text-align:center;'>Hoorian Cosmetics & Jewelry</h3>";
  html += "<hr/>";
  html += "<div>Invoice: " + inv.number + "</div>";
  html += "<div>Date: " + formatDate(inv.date) + "</div>";
  html += "<div>Customer: " + inv.customer + "</div>";
  html += "<hr/>";
  html += "<table>";
  html += "<tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
  let total = 0;
  inv.items.forEach(it => {
    const line = it.qty * it.price;
    total += line;
    html += `
      <tr>
        <td>${it.name}</td>
        <td>${it.qty}</td>
        <td>${it.price.toFixed(0)}</td>
        <td>${line.toFixed(0)}</td>
      </tr>
    `;
  });
  html += "</table>";
  html += "<hr/>";
  html += "<strong>Total: " + total.toFixed(0) + " PKR</strong>";
  openPrintWindow(html, "Invoice Slip");
});

document.getElementById("btnPrintA4").addEventListener("click", () => {
  if (!currentInvoiceForPrint) return alert("Select an invoice first");
  const inv = currentInvoiceForPrint;
  let html = "";
  html += "<h2>Hoorian Cosmetics & Jewelry</h2>";
  html += "<hr/>";
  html += "<div><strong>Invoice:</strong> " + inv.number + "</div>";
  html += "<div><strong>Date:</strong> " + formatDate(inv.date) + "</div>";
  html += "<div><strong>Customer:</strong> " + inv.customer + "</div>";
  html += "<hr/>";
  html += "<table>";
  html += "<tr><th>Item</th><th>Qty</th><th>Price</th><th>Total</th></tr>";
  let total = 0;
  inv.items.forEach(it => {
    const line = it.qty * it.price;
    total += line;
    html += `
      <tr>
        <td>${it.name}</td>
        <td>${it.qty}</td>
        <td>${it.price.toFixed(0)}</td>
        <td>${line.toFixed(0)}</td>
      </tr>
    `;
  });
  html += "</table>";
  html += "<h3>Total: " + total.toFixed(0) + " PKR</h3>";
  openPrintWindow(html, "Invoice A4");
});

/* BACKUP / RESTORE */
const setUser = document.getElementById("setUser");
const setPass = document.getElementById("setPass");
const btnSaveLogin = document.getElementById("btnSaveLogin");
const btnExportData = document.getElementById("btnExportData");
const btnClearAllData = document.getElementById("btnClearAllData");
const btnImportData = document.getElementById("btnImportData");
const backupJson = document.getElementById("backupJson");

btnSaveLogin.addEventListener("click", () => {
  const u = setUser.value.trim();
  const p = setPass.value.trim();
  if (!u || !p) return alert("Username & password required");
  localStorage.setItem(KEY_LOGIN, JSON.stringify({ username: u, password: p }));
  alert("Login updated");
});

btnExportData.addEventListener("click", () => {
  const data = {
    products,
    invoices,
    expenses,
    login: JSON.parse(localStorage.getItem(KEY_LOGIN) || "null")
  };
  backupJson.value = JSON.stringify(data, null, 2);
  alert("Data exported below");
});

btnImportData.addEventListener("click", () => {
  if (!backupJson.value.trim()) return alert("Paste JSON first");
  try {
    const data = JSON.parse(backupJson.value);
    if (data.products) { products = data.products; saveProducts(); }
    if (data.invoices) { invoices = data.invoices; saveInvoices(); }
    if (data.expenses) { expenses = data.expenses; saveExpenses(); }
    if (data.login) localStorage.setItem(KEY_LOGIN, JSON.stringify(data.login));
    alert("Data imported");
    refreshAll();
  } catch {
    alert("Invalid JSON");
  }
});

btnClearAllData.addEventListener("click", () => {
  if (!confirm("Clear ALL data?")) return;
  localStorage.removeItem(KEY_PRODUCTS);
  localStorage.removeItem(KEY_INVOICES);
  localStorage.removeItem(KEY_EXPENSES);
  localStorage.removeItem(KEY_LOGIN);
  products = [];
  invoices = [];
  expenses = [];
  cart = [];
  loadData();
  refreshAll();
  alert("All data cleared. Default login restored.");
});

/* INIT */
function refreshAll() {
  renderInventory();
  renderPosSearch();
  renderCart();
  renderExpenses();
  renderInvoices();
  refreshDashboard();
  const login = JSON.parse(localStorage.getItem(KEY_LOGIN) || "null");
  if (login) {
    setUser.value = login.username;
    setPass.value = login.password;
  }
}

loadData();
updateHeaderDate();
refreshAll();
showView("dashboardView");
</script>
</body>
</html>


